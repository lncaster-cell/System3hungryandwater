# System3hungryandwater

Репозиторий с акцентом только на **NWScript**-реализацию производительных механик:
- лагерь,
- перемещение партий между городами,
- встречи в пути,
- торговля.

## NWScript-модули
- `nwscript/system_core.nss` — единые ключи локальных переменных и общие helper-функции.
- `nwscript/camp_system.nss` — состояние лагеря и понижение активности.
- `nwscript/travel_system.nss` — маршруты между городами по timestamp-модели.
- `nwscript/encounter_system.nss` — детерминированные встречи в окнах времени.
- `nwscript/trade_system.nss` — integer-only торговля: стандартный магазин, отдельный режим оптовой торговли ресурсами (тонны, лоты, ledger без инвентарных ограничений), подготовка данных для GUI и вкладок.
- `nwscript/city_law_system.nss` — система пакетов городских законов: владелец города назначает закон-пакет, а его параметры управляют поведением стражи и городскими модификаторами (спрос/предложение/процветание/трафик/население).
- `nwscript/ambientlive2_bridge.nss` — мост синхронизации состояния для совместимости с ambientlive2 (schema/revision, экспорт/импорт партии, городов, городских торговых параметров и торговых позиций).

## Принципы производительности
- Нет обязательного фонового per-tick обновления всей карты.
- Событийная модель: расчёт выполняется только по запросу/событию.
- Целочисленная арифметика для минимизации накладных расходов.
- Локальные переменные объектов для дешёвой сериализации состояния.
- Для оптовой торговли используется агрегированный `cargo ledger` в тоннах вместо спавна предметов поштучно.

## Совместимость с ambientlive2
- Добавлен отдельный интеграционный слой `ambientlive2_bridge.nss` без фоновых циклов, чтобы обе системы обменивались состоянием через общий объект-шину (`oSyncBus`).
- В sync-контракт включены городские владельцы, назначенные law-пакеты и сами параметры пакетов законов для межрепозиторного переноса логики поведения стражи и влияния законов на параметры города/население.
- Контракт обмена версионирован (`AL2_SCHEMA_VERSION`) и использует монотонный `REVISION`, что предотвращает применение устаревших пакетов состояния.
- Обмен покрывает ключевые механики: лагерь, путешествие, встречи, баланс, координаты городов, параметры экономики города (supply/demand/prosperity/traffic) и торговые строки (включая оптовые).
