# System3hungryandwater

Репозиторий содержит **переносимую NWScript-реализацию системного слоя RPG-механик** с упором на производительность и совместимость между проектами.

Ключевая идея: все механики работают в **event-driven режиме**, без тяжелых фоновых циклов, на целочисленной математике и локальных переменных объектов.

---

## 1) Что уже реализовано

### Базовое ядро (`nwscript/system_core.nss`)
- Единый реестр `KEY_*` для всех подсистем (партия, города, торговля, законы, интеграционный sync).
- Общие функции для безопасных и дешевых операций:
  - `AbsInt`,
  - `ClampMinInt`,
  - `SaturatingAddInt`.
- Генераторы ключей для:
  - карты городов,
  - законов,
  - торговых листингов,
  - оптовой торговли,
  - cargo-ledger,
  - bridge-полей `AL2_SYNC_*`.

### Лагерь (`nwscript/camp_system.nss`)
- Переключение флага лагеря для партии.
- Массовое применение пониженного activity-множителя по членам группы.
- Проверка текущего состояния лагеря.

### Путешествия (`nwscript/travel_system.nss`)
- Регистрация городов с координатами в milli-единицах.
- Быстрый расчет времени маршрута по Manhattan-дистанции (`|dx| + |dy|`).
- Старт маршрута с записью travel-state (`FROM/TO/START/ARRIVAL/SEED`).
- Разрешение прибытия в `O(1)` по timestamp без фоновой симуляции.

### Встречи в пути (`nwscript/encounter_system.nss`)
- Детерминированный `HashRoll(seed, route, bucket)`.
- Проверка только по событию/запросу (`ShouldTriggerEncounter`), без глобального тика.
- Привязка к fingerprint маршрута для устойчивого результата и переносимости.

### Торговля (`nwscript/trade_system.nss`)
- Баланс игрока и листинги торговца на int-полях.
- Розничная покупка `BuyOneLine` с атомарной валидацией и коммитом.
- Выбор места хранения покупки:
  - личный инвентарь,
  - лагерный склад (если партия в лагере).
- Оптовый контур ресурсов:
  - `SetResourceMerchantListing`,
  - `BuildResourceTradeGui`,
  - `BuyResourceLineTons`.
- `cargo ledger` для крупных объемов (тонны), без спавна тысяч физических предметов.
- Модуль нелегальных товаров:
  - `SetIllegalMerchantListing`,
  - `BuyIllegalLine`,
  - поддержка типа товара и наценки.
- Подготовка GUI-данных и вкладок (включая отдельную вкладку городских параметров из sync).

### Законы городов (`nwscript/city_law_system.nss`)
- Хранение владельца города и назначенного law-пакета.
- Регистрация law-пакетов:
  - реакция/досмотр/сила стражи,
  - налог,
  - контроль контрабанды.
- Регистрация влияний на город:
  - demand/supply/prosperity/traffic/population,
  - racial pressure.
- Применение эффектов law-пакета к экономике и контексту города.
- Реестр нелегальных товаров и расчет риск/ценовых параметров под городские законы.

### Совместимость с ambientlive2 (`nwscript/ambientlive2_bridge.nss`)
- Двусторонний экспорт/импорт состояния через объект-шину `oSyncBus`.
- Namespace ключей `AL2_SYNC_*`.
- Контракт версии (`AL2_SCHEMA_VERSION`) и ревизионный gate (`REVISION`) против устаревших пакетов.
- Передаются:
  - партия,
  - маршрут,
  - встреча,
  - баланс,
  - города и их координаты,
  - городские торговые параметры,
  - law-пакеты и state по городам,
  - розничные/оптовые торговые позиции.

---

## 2) Производительные принципы (важно для переноса)

1. **Нет обязательного per-tick цикла по всей карте**.
2. **Событийность и ленивый расчет** — считаем только когда есть повод.
3. **Integer-only логика** — предсказуемо и дешево для NWScript runtime.
4. **Локальные переменные объектов** как хранилище состояния (дешевая сериализация/репликация).
5. **Агрегирование вместо материализации**:
   - опт хранится как тоннаж в ledger,
   - избегается массовый спавн инвентарных объектов.
6. **Детерминизм**:
   - повторяемый результат встреч,
   - стабильный перенос между репозиториями.

---

## 3) Сложность ключевых операций

- Переключение лагеря: `O(P)` только в момент переключения (`P` — размер партии).
- Старт/финиш путешествия: `O(1)`.
- Проверка встречи: `O(1)` за вызов.
- Покупка розничной строки: `O(1)`.
- Покупка оптового лота: `O(1)`.
- Применение law-пакета к конкретному городу: `O(1)`.
- Сборка UI: `O(N)` по количеству выводимых строк (рекомендуется пагинация при больших списках).

---

## 4) Что важно учесть при переносе в другой проект

### Данные и ключи
- Сохраняйте структуру `KEY_*` и `AL2_SYNC_*` без переименований.
- Если добавляете несовместимые поля sync — повышайте schema version.

### Контракт интеграции
- Принимать snapshot только при `incoming_revision > current_revision`.
- Сначала импортировать базовый state партии, затем города/законы/торговлю.

### Экономика и торговля
- Для крупного опта используйте только ledger (тонны/лоты).
- Не переводите опт в физические item-стэки без необходимости.
- Для больших каталогов товаров вводите pagination и partial refresh.

### Путешествия и встречи
- Оставляйте timestamp-модель прибытия, не вводите постоянные world-loop обновления.
- Сохраняйте route fingerprint + bucket-подход для repeatable encounter-решений.

### Законы/городской контроль
- Law-пакеты должны быть отдельным слоем конфигурации, а не хардкодом в торговых функциях.
- Нелегальные товары лучше хранить простым списком (тип + наценка) без тяжелых зависимостей.

---

## 5) Готовый промт для переноса (можно копировать в новый репозиторий/чат)

```text
Перенеси и адаптируй системный NWScript-слой из System3hungryandwater в новый проект.

Цели:
1) Сохранить event-driven архитектуру без фонового per-tick цикла.
2) Сохранить integer-only вычисления и локальные переменные объектов как основное хранилище состояния.
3) Перенести механики полностью:
   - camp system (флаг лагеря + activity multiplier по партии),
   - travel system (регистрация городов, Manhattan-дистанция, timestamp arrival),
   - encounter system (детерминированный HashRoll по seed/route/bucket),
   - trade system (розница, опт в тоннах/лотах через cargo ledger, выбор storage mode, нелегальные товары),
   - city law system (owner, law packages, guard/tax/contraband параметры, economy/population/racial impacts),
   - ambientlive2 bridge (AL2_SYNC_* экспорт/импорт, schema + revision gating).

Требования производительности:
- никаких глобальных циклов обновления карты;
- O(1) для travel resolve / encounter check / buy line / buy wholesale lot;
- защита от overflow для price*qty и lot*count;
- минимизация строковых rebuild в UI (по возможности pagination + dirty update).

Требования совместимости:
- сохранить namespace ключей KEY_* и AL2_SYNC_*;
- импортировать только более новую ревизию;
- для несовместимых изменений повышать версию схемы.

Результат:
- подготовь список перенесенных функций по модулям;
- укажи где были изменены ключи/контракт;
- опиши риски регрессии и план smoke-тестов по каждому модулю.
```

---

## 6) Структура репозитория

- `nwscript/system_core.nss` — общие ключи и helper-ы.
- `nwscript/camp_system.nss` — лагерь.
- `nwscript/travel_system.nss` — маршруты и прибытие.
- `nwscript/encounter_system.nss` — встречи.
- `nwscript/trade_system.nss` — розница, опт, нелегальные товары, GUI-подготовка.
- `nwscript/city_law_system.nss` — закон-пакеты, влияние на город, контрабанда.
- `nwscript/ambientlive2_bridge.nss` — межрепозиторный sync-контракт.
- `docs/` — архитектурные и audit-документы для технического переноса.

---

## 7) Статус

Проект ориентирован на **минимальный runtime overhead** и уже подходит как базовый «переносимый каркас» для RPG-механик в NWScript-среде.
