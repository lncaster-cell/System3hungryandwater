# Архитектура (NWScript): лагерь, путешествия, встречи, торговля

## Цель
Сделать механики максимально «лёгкими» для runtime Neverwinter Nights/NWScript:
- минимум постоянных циклов;
- максимум событийной и ленивой логики;
- integer-only вычисления.

## Компоненты

### 0) Базовый слой (`nwscript/system_core.nss`)
- Централизует ключи (`KEY_*`) для локальных переменных.
- Даёт общие helper-функции (`ClampMinInt`, `AbsInt`, генерация ключей инвентаря/листа/городов).
- Убирает дублирование строковых литералов и снижает риск рассинхронизации между скриптами.

### 1) Лагерь (`nwscript/camp_system.nss`)
- `SetPartyCampState(...)` выставляет флаг лагеря и снижает множитель активности членов партии.
- `ApplyPartyActivityMultiplier(...)` применяет режим активности к каждому участнику.
- `IsPartyCamped(...)` возвращает текущий флаг.

### 2) Путешествия (`nwscript/travel_system.nss`)
- Города хранятся на объекте модуля через ключи `CityXKey/CityYKey`.
- Дистанция — Manhattan (`|dx| + |dy|`) без `sqrt`.
- При старте маршрута вычисляется только `KEY_TRAVEL_ARRIVAL_MS`.
- При `ResolveArrival(...)` выполняется одно сравнение времени, перенос партии и очистка travel-state.

### 3) Встречи (`nwscript/encounter_system.nss`)
- Проверка встреч только когда реально нужно (`ShouldTriggerEncounter`).
- Детерминизм обеспечивается целочисленным `HashRoll(seed, route, bucket)`.
- `route` вычисляется на базе `from/to city`, а не косвенно по timestamp.
- Никаких фоновых списков событий на весь маршрут.

### 4) Торговля (`nwscript/trade_system.nss`)
- Балансы, цены, остатки и инвентарь — локальные int-переменные.
- `BuyOneLine(...)` валидирует и коммитит операцию атомарно для одной строки покупки.
- Единые ключи цен/остатков/инвентаря через helper-функции.

## Сложность
- Лагерь: `O(P)` по членам партии только в момент переключения.
- Старт/финиш путешествия: `O(1)`.
- Проверка встречи: `O(1)` на одну проверку.
- Покупка строки: `O(1)`.

## Практический итог
Подход даёт близкую к нулю нагрузку в idle-сценариях, потому что система не делает массовых обновлений «каждый тик», а работает только по событиям игрового процесса.
