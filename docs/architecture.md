# Архитектура (NWScript): лагерь, путешествия, встречи, торговля

## Цель
Сделать механики максимально «лёгкими» для runtime Neverwinter Nights/NWScript:
- минимум постоянных циклов;
- максимум событийной и ленивой логики;
- integer-only вычисления.

## Компоненты

### 1) Лагерь (`nwscript/camp_system.nss`)
- `SetPartyCampState(...)` выставляет флаг лагеря и снижает множитель активности членов партии.
- `IsPartyCamped(...)` возвращает текущий флаг.
- Интеграция с нуждами строится через локальную переменную `NEED_ACTIVITY_MILLI`.

### 2) Путешествия (`nwscript/travel_system.nss`)
- Города хранятся на объекте модуля через `CITY_X_<id>`, `CITY_Y_<id>`.
- Дистанция — Manhattan (`|dx| + |dy|`) без `sqrt`.
- При старте маршрута вычисляется только `TRAVEL_ARRIVAL_MS`.
- При `ResolveArrival` выполняется одно сравнение времени и перенос партии в целевой город.

### 3) Встречи (`nwscript/encounter_system.nss`)
- Проверка встреч только когда реально нужно (`ShouldTriggerEncounter`).
- Детерминизм обеспечивается целочисленным `HashRoll(seed, route, bucket)`.
- Никаких фоновых списков событий на весь маршрут.

### 4) Торговля (`nwscript/trade_system.nss`)
- Балансы, цены, остатки и инвентарь — локальные int-переменные.
- `BuyOneLine(...)` валидирует и коммитит операцию атомарно для одной строки покупки.
- Без float и без тяжёлых структур в горячем пути.

## Сложность
- Лагерь: `O(P)` по членам партии только в момент переключения.
- Старт/финиш путешествия: `O(1)`.
- Проверка встречи: `O(1)`.
- Покупка строки: `O(1)`.

## Практический итог
Подход даёт близкую к нулю нагрузку в idle-сценариях, потому что система не делает массовых обновлений «каждый тик», а работает только по событиям игрового процесса.
