# Архитектура (NWScript): лагерь, путешествия, встречи, торговля

## Цель
Сделать механики максимально «лёгкими» для runtime Neverwinter Nights/NWScript:
- минимум постоянных циклов;
- максимум событийной и ленивой логики;
- integer-only вычисления.

## Компоненты

### 0) Базовый слой (`nwscript/system_core.nss`)
- Централизует ключи (`KEY_*`) для локальных переменных.
- Даёт общие helper-функции (`ClampMinInt`, `AbsInt`, генерация ключей инвентаря/листа/городов).
- Убирает дублирование строковых литералов и снижает риск рассинхронизации между скриптами.
- Включает ключи для отдельного режима resource-торговли (оптовый прайс/остаток/лот, cargo-ledger, tab state).

### 1) Лагерь (`nwscript/camp_system.nss`)
- `SetPartyCampState(...)` выставляет флаг лагеря и снижает множитель активности членов партии.
- `ApplyPartyActivityMultiplier(...)` применяет режим активности к каждому участнику.
- `IsPartyCamped(...)` возвращает текущий флаг.

### 2) Путешествия (`nwscript/travel_system.nss`)
- Города хранятся на объекте модуля через ключи `CityXKey/CityYKey`.
- Дистанция — Manhattan (`|dx| + |dy|`) без `sqrt`.
- При старте маршрута вычисляется только `KEY_TRAVEL_ARRIVAL_MS`.
- При `ResolveArrival(...)` выполняется одно сравнение времени, перенос партии и очистка travel-state.

### 3) Встречи (`nwscript/encounter_system.nss`)
- Проверка встреч только когда реально нужно (`ShouldTriggerEncounter`).
- Детерминизм обеспечивается целочисленным `HashRoll(seed, route, bucket)`.
- `route` вычисляется на базе `from/to city`, а не косвенно по timestamp.
- Никаких фоновых списков событий на весь маршрут.

### 4) Торговля (`nwscript/trade_system.nss`)
- Балансы, цены, остатки и инвентарь — локальные int-переменные.
- `BuyOneLine(...)` валидирует и коммитит операцию атомарно для одной строки покупки.
- Поддержан выбор места хранения покупки: личный инвентарь или лагерный склад (доступен только в лагере).
- Добавлен отдельный торговый контур `BuildResourceTradeGui(...)` + `BuyResourceLineTons(...)` для оптовой торговли ресурсами в тоннах.
- Для крупногабаритных партий используется `cargo ledger` (агрегированное хранение тоннами), а не инвентарь персонажа.
- Добавлен модуль нелегальных товаров в формате простого списка: `SetIllegalMerchantListing(...)` + `BuyIllegalLine(...)` работают с типом товара (например, наркотики) и фиксированной наценкой без избыточной логики.
- `BuildResourceCityTabFromAmbientLive2(...)` формирует отдельную вкладку параметров городов (demand/supply/prosperity/traffic), данные берутся из `AL2_SYNC_*`.
- `OpenResourceTradeFromDialog(...)` позволяет запускать интерфейс из отдельной ветки диалога (обычный торговец или спец-торговец).

## Сложность
- Лагерь: `O(P)` по членам партии только в момент переключения.
- Старт/финиш путешествия: `O(1)`.
- Проверка встречи: `O(1)` на одну проверку.
- Покупка строки: `O(1)`.
- Покупка оптового лота: `O(1)`.
- Покупка нелегальной позиции: `O(1)` без фоновых проверок.
- Сборка UI: `O(N)` по числу отображаемых строк, без фоновых апдейтов.

## Практический итог
Подход даёт близкую к нулю нагрузку в idle-сценариях, потому что система не делает массовых обновлений «каждый тик», а работает только по событиям игрового процесса.

### 5) Законы городов (`nwscript/city_law_system.nss`)
- Для каждого города хранится `owner` и назначенный `law package`.
- `RegisterLawPackage(...)` задаёт базовый пакет законов (реакция/досмотр/сила стражи, торговый налог, контроль контрабанды).
- `RegisterIllegalItem(...)` задаёт профиль нелегального товара как элемент списка (тип + наценка чёрного рынка).
- `RegisterLawPackageImpact(...)` задаёт влияние закона на экономику и демографию города (demand/supply/prosperity/traffic/population) и уровень расового давления.
- `AssignCityLawPackage(...)` переключает пакет по решению владельца города и поднимает ревизию закона города.
- `ApplyCityLawContext(...)` копирует активные правовые коэффициенты и дельты влияния закона в контекст NPC/сцены для downstream-логики стражников и других систем.
- `ApplyCityLawEconomyImpact(...)` применяет текущие law-дельты к параметрам города и населению в saturating/clamp формате.
- `ComputeGuardInterventionScoreMilli(...)` даёт единый детерминированный скор вмешательства стражи с учётом активных законов.
- `BuyIllegalLine(...)` сохраняет лёгкий контекст последней нелегальной покупки (город/товар/кол-во) для downstream-скриптов без дополнительных вычислений.

### 6) Межрепозиторная совместимость (`nwscript/ambientlive2_bridge.nss`)
- Вводит версионированный sync-контракт для ambientlive2 через `AL2_SCHEMA_VERSION`.
- Использует `AL2_SYNC_*` namespace, чтобы не конфликтовать с runtime-ключами.
- `AL2ExportPartySnapshot/AL2ImportPartySnapshot` синхронизируют состояние партии (город, лагерь, travel, encounters, balance).
- `AL2ExportCity/AL2ImportCity` обеспечивают двусторонний обмен координатами городов.
- `AL2ExportCityTradeParams/AL2ImportCityTradeParams` синхронизируют параметры торгового профиля города, включая население.
- `AL2ExportCityLawState/AL2ImportCityLawState` синхронизируют владельца, выбранный law-пакет и ревизию законов города.
- `AL2ExportLawPackage/AL2ImportLawPackage` синхронизируют содержимое law-пакетов (параметры стражи/налогов/контрабанды + экономические/демографические дельты и расовое давление).
- `AL2ExportMerchantItem/AL2ImportMerchantItem` синхронизируют стандартные и оптовые торговые позиции по item-id.
- Контроль ревизий исключает откат на устаревшее состояние при асинхронном обмене.
