# Контракт совместимости System3hungryandwater ↔ ambientlive2

Дата: 2026-02-15

## Цель
Обеспечить полную взаимосвязь на уровне состояния между репозиториями через единый NWScript-мост `nwscript/ambientlive2_bridge.nss`.

## Модель интеграции
- Обмен идёт через объект-шину `oSyncBus` (module object, placeable или другой общий объект).
- Все поля в шине имеют namespace `AL2_SYNC_`.
- Версия контракта хранится в `AL2_SYNC_SCHEMA`.
- Каждая публикация состояния увеличивает `AL2_SYNC_REVISION`.
- Импорт допускается только если `incoming_revision > current_revision`.

## Синхронизируемые блоки
1. **Состояние партии:**
   - город, размер, лагерь;
   - travel-стейт (`ACTIVE/FROM/TO/START/ARRIVAL/SEED`);
   - encounter-стейт (`LAST_MS/SEVERITY/ACTOR_TYPE/KIND/STARTS_IN_COMBAT`);
   - баланс.
2. **Мир/карта:** координаты города по `cityId`.
3. **Параметры торгового профиля города:** `DEMAND/SUPPLY/PROSPERITY/TRAFFIC` (milli-int).
4. **Торговля:** стандартные и оптовые позиции по `itemId`:
   - розница: `LIST_PRICE_*`, `LIST_STOCK_*`;
   - опт: `LIST_WHOLESALE_PRICE_*`, `LIST_WHOLESALE_STOCK_TONS_*`, `LIST_WHOLESALE_LOT_TONS_*`.

## Канонический цикл обмена
1. Источник вызывает `AL2ExportPartySnapshot(...)` и получает новую ревизию.
2. Источник (опционально) экспортирует нужные города/товары по id:
   - `AL2ExportCity(...)` + `AL2ExportCityTradeParams(...)`;
   - `AL2ExportMerchantItem(...)`.
3. Приёмник проверяет `AL2CanImportFrom(...)`.
4. Приёмник применяет `AL2ImportPartySnapshot(...)` и импортирует города/товары.

## Гарантии
- Без фоновых тиков: совместимость не ухудшает производительность.
- Защита от устаревших пакетов через revision gating.
- Детерминированный набор ключей на базе существующих `KEY_*` и helper-генераторов.

## Что нужно сделать в ambientlive2
- Использовать те же поля `AL2_SYNC_*` и ревизионную политику.
- Для торгового UI использовать вкладку «города» на данных `CITY_*_MILLI_*` из sync-bus.
- Для оптовой торговли работать с лотами/тоннами и не материализовать физические предметы в инвентаре.
- При наличии собственных расширений добавлять поля в этом же namespace без изменения базовых ключей.
- Для новых несовместимых полей повышать `AL2_SCHEMA_VERSION`.
